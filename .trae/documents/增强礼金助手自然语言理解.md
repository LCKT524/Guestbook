## 现状与问题
- 解析核心在 `src/lib/agent/gift-sprite.ts` 的 `parseMessage`（e:\Idea-workspace\Guestbook\src\lib\agent\gift-sprite.ts:19-88），桥接在 `agentBridge.ts`（e:\Idea-workspace\Guestbook\src\lib\agent\agentBridge.ts:27-63）。
- 事件、关系、支付方式靠小型词典与正则；联系人抽取依赖“边界词+姓名2-3字”规则；节日词被直接清理（同文件:63）。
- 局限：
  1) 金额不支持中文数字与单位（如“两千”“3k”“一万二”）。
  2) 日期不支持相对表达与节日映射（如“昨天”“上周六”“国庆”）。
  3) 事件归一粒度有限，未系统覆盖“满月宴/寿宴/乔迁/升学/开业”等变体、别称。
  4) 联系人识别对称呼/后缀不鲁棒（如“王哥”“张老师”“小李”）。
  5) 备注始终为空，未保留未识别信息。
  6) 节日词在联系人清洗阶段直接删除（e:\Idea-workspace\Guestbook\src\lib\agent\gift-sprite.ts:63），影响事件/日期理解。

## 目标
- 全面提升对中文自然语言红包场景的抽取：金额、日期、事件、联系人、关系、支付方式、备注。
- 在保持轻量规则的前提下，覆盖主流口语与变体，提高鲁棒性与召回。

## 技术方案
### 1. 金额解析升级
- 新增中文数字解析：支持“十/百/千/万/亿”与口语“俩/两”。示例：“一千二”“两千五”“三万八”。
- 扩展单位与缩写：`k/K`（千）、`w/W`（万），以及“百/千/万”。
- 统一货币符号与全角数字：识别 `￥/¥`、全角 `１２３４`。
- 规则：优先匹配显式阿拉伯数字，其次匹配中文数字；若出现多个金额，取与“随礼/回礼”近邻的一个。

### 2. 日期理解升级
- 相对时间：支持“今天/昨天/前天/上周六/本周六/周末”等，映射到具体日期。
- 节日映射：将“春节/清明/端午/中秋/国庆”映射到当年法定或约定日期，保留事件为“节日红包”。
- 多格式兼容：`YYYY-MM-DD`、`YYYY/MM/DD`、`MM-DD`（默认当前年）、带汉字的“2025年11月18日”。
- 调整清洗顺序：先识别节日与日期，再进行联系人清洗，避免提前删除词汇。

### 3. 事件归一增强
- 构建事件同义词表：
  - 婚礼类：婚礼/结婚/婚宴/喜酒/办喜事/摆酒。
  - 满月类：满月/满月酒/百日/百天。
  - 寿宴类：寿宴/生日/过寿。
  - 乔迁类：乔迁/搬家宴/入宅。
  - 升学类：升学/升学宴/考上/录取通知。
  - 开业类：开业/开张/开业庆典。
- 节日类：春节/清明/端午/中秋/国庆 → “节日红包”。
- 归一策略：按优先级从明确事件到通用“人情往来”。

### 4. 联系人与关系识别增强
- 姓名规则放宽：支持 1–4 字中文，允许称呼后缀/前缀（哥/姐/老师/叔叔/阿姨/舅舅/嫂子/老/小/大）。保留原词作为 `contact_name`，同时生成归一版 `contact_name_normalized`（去除称呼）。
- 关系词扩展与归一：同事/朋友/同学/领导/老师/亲戚/邻居/表兄妹等，作为 `relation` 字段返回。
- 边界词扩展：加入“份子/份子钱/礼金/随份子/礼物/红包”等以提升片段截断稳定性。
- 句式覆盖：支持“给某某随礼”“收到某某回礼”“某某的婚礼/满月”等倒装和内联结构。

### 5. 支付方式识别
- 细化到子类型：微信红包/微信转账/支付宝转账/银行卡转账/现金。
- 规则优先级：从近邻动词“转账/红包/现金”判定，缺省仍为微信。

### 6. 备注保留
- 将未被抽取的剩余文本作为 `notes`，并去除已识别实体与停用词，保留关键信息（如“餐标较高”“农村老家”）。

### 7. 解析管线与评分
- 管线顺序：`type → amount → date → event → contact → relation → payment → notes`。
- 距离与上下文评分：当出现多候选时，选择与触发词（随礼/回礼/事件词）距离最近者。
- 输出结构新增字段：`relation`、`contact_name_normalized`、`event_category`（婚礼/满月/寿宴/乔迁/升学/开业/节日/其他）。

### 8. 单元与回归用例
- 覆盖典型口语：
  - “刚给同事张伟随礼800结婚红包”。
  - “收到李娜回礼1200”。
  - “上周六给王哥孩子满月随份子两千五”。
  - “国庆给表弟礼金3k 微信转账”。
  - “昨天参加老李乔迁，随礼一千二”。
  - “中秋收阿姨回礼500红包”。
- 断言字段：`type/amount/date/event/contact/relation/payment/notes`。

### 9. 兼容与桥接
- `agentBridge` 仍优先云端解析；本地回退逻辑保持，新增字段兼容前端展示。
- 若远端返回更丰富结构，做同名字段合并，避免覆盖本地增强。

## 交付节奏
- 第一阶段：金额与日期升级 + 测试。
- 第二阶段：事件与联系人/关系增强 + 测试。
- 第三阶段：支付方式细化、备注保留、输出结构扩展 + 回归。

## 请确认
- 是否接受以上升级方向与分阶段实现；确认后将开始具体代码改造与测试落地。