## 目标
- 连接真实后端并使前端操作可持久化到数据库
- 在应用内集成“人情小精灵”智能体，支持自然语言录入与查询

## 后端对接（Supabase）
- 环境变量：在 `.env` 设置 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`
- 数据库表与字段：
  - contacts：`id`(uuid), `user_id`(uuid), `name`, `phone`, `relationship`, `notes`, `metadata`(jsonb), `created_at`(timestamptz), `updated_at`
  - records：`id`(uuid), `user_id`(uuid), `contact_id`(uuid, fk), `type`(enum: gift_given|gift_received), `event_name`, `event_date`(date), `amount`(numeric), `payment_method`, `notes`, `attachments`(jsonb), `created_at`, `updated_at`
  - categories：`id`(uuid), `user_id`(uuid), `name`, `type`(enum: event|relationship), `color`, `sort_order`(int), `created_at`
- 关系与索引：
  - `records.contact_id → contacts.id`（on delete set null）
  - 索引：`contacts(user_id,name)`、`records(user_id,event_date)`、`categories(user_id,type,sort_order)`
- 安全（RLS）：开启 RLS 并添加策略（select/insert/update/delete 仅限 `auth.uid() = user_id`）
- 验证：用 Supabase 控制台或 SQL seed 创建 1–2 条数据，前端列表应能加载

## 前端切换到真实后端
- 关闭演示模式：设置有效的 Supabase 环境变量后，`isDemo` 为 false（`src/lib/supabase-client.ts` 与 `src/lib/supabase-client-fixed.ts` 已内置判断）
- 表单数据流：`RecordAdd`/`Contacts` 等页面使用 `recordsAPI/contactsAPI` 写入真实库（现有 API 封装已就绪）
- 错误处理：沿用 `react-hot-toast` 提示，必要时补充更详细的错误文案
- 验证路径：登录 → 新增联系人 → 添加记录 → 列表与统计显示 → 导出/导入操作

## 集成“人情小精灵”智能体
- 能力目标：
  - 自然语言录入：如“刚给同事张伟随礼800元结婚红包”→ 自动解析并写入 `records`
  - 查询统计：如“查今年记录”、“我给张伟总共随了多少”→ 返回聚合结果
  - 回礼识别：如“收到李娜回礼1200”→ 录入 `gift_received`
- 前端实现：
  - 新增路由 `/assistant` 与页面 `Assistant`：输入框 + 对话列表 + 快捷建议
  - 解析器：`src/lib/agent/gift-sprite.ts` 轻量规则（正则/分词）→ 标准化结构 `{type, contact, event, amount, date, payment_method, notes}`
  - 动作映射：解析成功后调用 `recordsAPI/contactsAPI`；失败返回友好提示与纠错建议
  - 会话记录：可选将交互写入 `agent_logs`（表：`id,user_id,intent,payload,result,created_at`）
- 与已有智能体对接（可选）：
  - 若“人情小精灵”提供 HTTP/SDK 接口，创建 `src/lib/agent/client.ts` 适配器，方法：`recordOutgoingGift`、`recordIncomingGift`、`getYearStats` 等
  - 在 `Assistant` 页面优先调用智能体接口；无接口或失败时回退到本地解析器

## 安全与合规
- 不在日志/界面暴露 Supabase Keys
- RLS 与最小权限原则
- 输入校验与异常提示（金额、日期、手机号等）

## 交付与验证
- 端到端验证：登录 → 智能体录入几条不同类型记录 → 列表/统计实时更新
- 导出/导入验证：导出 Excel 后与数据库对账；导入后检查数据一致
- 截图与短视频：演示智能体对话、自动录入、查询统计、错误纠正

## 后续迭代
- 响应式优化与桌面端布局增强
- 智能体意图覆盖率扩展（模糊金额、自然日期、别名匹配）
- 更丰富的建议卡片（节日提示、回礼提醒、历史联动）