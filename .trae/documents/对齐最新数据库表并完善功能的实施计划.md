## 目标
- 全面对齐 `20251114_init.sql` 的最新表结构，消除前端/服务端字段不一致导致的报错。
- 完善未完成或半成品的业务逻辑（默认分类初始化、字段统一、记录分类选择、展示与导入导出一致性）。

## 架构与现状核对
- 数据库字段：`records.record_date`、`records.note`、`records.category_id`；`contacts.address`、`contacts.notes`；`users` 表内置手机号登录字段。
- 代码使用情况：
  - 多处仍残留 `event_date`（示例：src/lib/supabase.ts:160、src/pages/Assistant.tsx:56 等）。
  - 代码侧使用 `notes`，库为 `note`（src/pages/Export.tsx:50、RecordAdd.tsx:45）。
  - 记录未绑定 `category_id`，列表未展示分类信息。
  - 注册逻辑在应用侧创建默认分类，但迁移中已有触发器，存在重复风险（src/contexts/AuthContext.tsx:57-62）。

## 变更计划
### 一、字段统一与类型修正
1. 统一日期字段为 `record_date`
   - 替换所有 `event_date` 的模型/查询/筛选/展示/导入导出逻辑。
   - 影响文件：
     - `src/lib/supabase-client.ts`（模型与查询）
     - `src/lib/supabase.ts` 与 `src/lib/supabase-client-fixed.ts`（备用客户端保持一致）
     - `src/pages/RecordAdd.tsx`、`Records.tsx`、`HomePage.tsx`、`Export.tsx`、`Import.tsx`、`Assistant.tsx`
2. 统一备注字段为 `note`
   - 将前端模型与写库从 `notes` 改为 `note`，展示层读取 `note`。
   - 影响文件：`src/lib/supabase-client.ts`、`RecordAdd.tsx`、`Records.tsx`、`Export.tsx`、`Assistant.tsx`、`Import.tsx`
3. 类型补全
   - `records` 增加 `category_id` 字段，模型与增改查支持可选分类。

### 二、默认分类初始化的重复问题
- 移除应用层注册时的默认分类创建（src/contexts/AuthContext.tsx:57-62），改为完全依赖迁移中的触发器 `trg_clone_default_categories_user`，避免重复数据。

### 三、记录分类选择与展示（完善功能）
1. 添加记录时支持选择分类 `category_id`
   - 在 `RecordAdd.tsx` 加入下拉框，加载当前用户的 `categories`（gift/expense/income），保存时写入 `category_id`。
2. 列表与详情展示分类标签
   - `Records.tsx` 在每条记录右侧或次要信息显示分类名称和颜色标识；查询可加入 `categories(name,color)` 联表字段。
3. 筛选支持按分类
   - 在礼簿页增加分类筛选项（可选），前端过滤与导出逻辑同时支持。

### 四、导入/导出与助手解析对齐
1. 导出
   - 输出 `record_date` 与 `note`，新增列“分类”。
2. 导入
   - 解析 `日期 → record_date`、`备注 → note`；支持可选“分类”列通过名称匹配 `category_id`。
3. 助手解析
   - `gift-sprite.ts` 的返回结构统一为 `record_date` 与 `note`，不再使用 `event_date`；`Assistant.tsx` 写库字段对齐。

### 五、认证与手机号校验
- 保留已实现的前端与服务端双重校验（`utils.ts` 的 `normalizePhone/isValidCNMobile/validatePhone`），并在用户登录成功后更新 `users.last_login`（可选增强）。

## 实施步骤（按序执行）
1. 替换所有 `event_date → record_date` 引用，确保编译通过与页面渲染正常。
2. 模型与页面字段从 `notes → note`；统一写入与展示。
3. 去除注册时应用层默认分类创建，改由触发器完成。
4. 增加 `category_id` 支持：
   - API 查询联表 `categories(name,color)`；新增/更新写入 `category_id`。
   - `RecordAdd.tsx` 分类选择；`Records.tsx` 分类标签展示与筛选。
   - 导出增加分类列；导入支持分类匹配。
5. 助手解析与录入对齐为 `record_date/note`。
6. 可选：登录后写 `last_login = now()`；联系人页面允许展示 `address`（已有字段）。

## 验证方案
- 启动本地开发：访问“礼簿/助手/导入/导出/联系人/注册登录”。
- 新增记录（含分类）、筛选与排序、导出 Excel、导入一份测试文件、助手录入文本“刚给同事张伟随礼800元结婚红包”。
- 观察是否再出现 `event_date` 字段缺失的报错；核对备注与日期一致。

## 交付物
- 对齐后的类型与 API 实现
- 更新的页面交互（分类选择/展示/筛选）
- 导入导出与助手解析的字段一致性
- 删除冗余默认分类创建逻辑

## 风险与回滚
- 若分类联表导致性能问题，可先只在列表页展示分类名，不进行跨表筛选。
- 保留原备用客户端文件但标记未使用，或统一到一个客户端以减少维护开销。